{% extends 'app/layouts/main.html' %}
{% block title %}
Mastering Page
{% endblock title %}
{% block content %}
<style>
    .full-page-box {
         display: flex;
         flex-direction: column;
         background-color: lightgrey;
         padding: 20px; 
         box-sizing: border-box;
         
     }
     .input-box-container{
         background-color:rgb(178, 178, 226);
     }
 
     .left-box {
         width: 350px;
         height: 100px;
         background-color: white; 
         margin-right: 10px;
         border: 2px solid black; 
     }
     label {
             display: inline-block;
             width: 150px; 
             margin-top: 15px;
             text-align: center;
             font-weight: bold;
         }
 
         select {
             margin-top: 10px;
             box-sizing: border-box;
             width: 50%; 
             height: 30px;
         } 
         #cancel-btn{
             background-color: orange;
             color:black;
             height: 40px;
             width: 130px;
             margin-left: 10px;
             margin-top: 10px;
               
         }
         #select-btn{
             background-color: green;
             color:black;           
             height: 40px;
             width: 130px; 
             margin-left: 65px; 
             margin-top: 10px;
         }
         #lowMasterBtn,#highMasterBtn{
             width: 250px;
             height: 40px;
             margin-left: 950px;
             margin-top: -60px;
             background-color: blue;
             color: white;
         }

         #measureBtn{
            width: 120px;
             height: 70px;
             margin-left: 800px;
             margin-top: -50px;
             background-color: rgb(255, 0, 76);
             color: white;
         }
         #highMasterBtn{    
             margin-top: 10px;   
         }
         
         .input-box-container {
             border: 2px solid black;
             padding: 10px;
             width: 180px;
             height: 140px;
             margin: 30px;
             box-sizing: border-box;
             
         }
         .master_input {
             margin-bottom: 10px;
             width: 42%;
             box-sizing: border-box;
         }
 
         #container-wrapper {
         display: flex;
         flex-wrap: wrap;
         }
 
         #probe-A,
         #probe-B,
         #probe-C,
         #probe-D,
         #probe-E,
         #probe-F,
         #probe-G,
         #probe-H,
         #probe-I,
         #probe-J,
         #probe-K {
             display: inline-block;
             max-height: 100px;
             width: 100px;
             margin-right: 10px; 
            
             
         }
 
        
 #pre{
         margin-top: 10px;
         color:white;
         font-size: 20px;
         font-weight: bold;
         text-align: center;
         background-color: rgb(250, 106, 54)
 
        }
        #clock-box{
         background-color:white;
         border-radius: 5px;
         height: 40px;
         border: 1px solid black;
         padding-top: 5px;
         font-weight: bold;
         max-width: 180px;
         margin-left: 1000px;
 
        }


.reset-button {
  position: relative;
  background-color: #007bff;
  border: none;
  border-radius: 30%;
  width: 40px;
  height: 40px;
  margin-top: -40px;
  margin-left: 1200px;
  padding: 0;
  cursor: pointer;
  overflow: hidden;
}

.reset-symbol {
  font-size: 20px;
  color: white;
  position: relative;
  z-index: 1;
}

.reset-button:before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 120%;
  height: 120%;
  background-color: rgba(255, 255, 255, 0.2);
  border-radius: 50%;
  transform: translate(-50%, -50%) rotateX(55deg) rotateY(30deg);
  transition: transform 0.5s ease;
}

.reset-button:hover:before {
  transform: translate(-50%, -50%) rotateX(0deg) rotateY(0deg);
}
        
        
 </style>
 

<div class="full-page-box" style="overflow-x: auto;overflow-y:auto;">
    <div id="clock">
        <div class="box" id="clock-box"></div>
    </div>

    <button class="reset-button" id="reset-button">
        <span class="reset-symbol">&#8634;</span>
    </button>

    <div class="left-box">
    
        <label for="partModel">PART MODEL:</label>
        <select id="partModel" name="partModel">
            {% for value in part_model_values %}
                <option value="{{ value }}">{{ value }}</option>
            {% endfor %}
        </select>
        <a href="{% url 'measurebox' %}" >
            <button type="button" id="cancel-btn"><b>Cancel</b></button>
            </a>
        <button type="button" id="select-btn"><b>Select</b></button>
    </div>
    <label for="all_parameter" style="margin-left: 370px; margin-top: -80px;">
        All Parameter
        <input type="radio" style="margin-left: 10px;" id="all_parameter" onclick="handleRadioClick(this)">
    </label>
    
    <label for="parameterwise" style="margin-left: 370px;">
        Parameterwise
        <input type="radio" style="margin-left: 7px;" id="parameterwise" onclick="handleRadioClick(this)">
    </label><br>
    
    <label for="mastering" style="margin-left: 510px;margin-top: -80px;">MASTERING GROUP:</label>
    <select id="mastering"  style="width: 10%;margin-left: 650px;margin-top: -40px;" name="mastering" >
        <script>
            for (var i = 1; i <= 30; i++) {
                document.write('<option value="' + i + '">' + i + '</option>');
            }
        </script>
    </select>
    <button id="measureBtn" type="button" onclick="MeasureBtnClick()"><b>Measurement<br>F1</b></button>
    <button id="lowMasterBtn" type="button" onclick="lowMasteringClick()"><b>Low Mastering</b></button>
    <button id="highMasterBtn" type="button" onclick="highMasteringClick()"><b>High Mastering</b></button>
    



    <pre id="pre" style="border: 2px solid black;"></pre>

  
   
    <textarea id="probe-A"></textarea>
    <textarea id="probe-B"></textarea>
    <textarea id="probe-C"></textarea>
    <textarea id="probe-D"></textarea>
    <textarea id="probe-E"></textarea>
    <textarea id="probe-F"></textarea>
    <textarea id="probe-G"></textarea>
    <textarea id="probe-H"></textarea>
    <textarea id="probe-I"></textarea>
    <textarea id="probe-J"></textarea>
    <textarea id="probe-K"></textarea>
    

    <div id="container-wrapper"></div>
</div>


<script>
     document.getElementById('reset-button').addEventListener('click', function() {
        location.reload();
        const preTag = document.getElementById('pre');
        preTag.innerText = "New Mastering is Started";
    });

    document.getElementById("lowMasterBtn").disabled = false;
    document.getElementById("lowMasterBtn").style.opacity = '1';
    document.getElementById("highMasterBtn").disabled = true;
    document.getElementById("highMasterBtn").style.opacity = '0.6';



    function MeasureBtnClick() {
        window.location.href = '/measurement/'; // Replace '/measurement' with the actual URL of the measurement page
    }
    function redirectToMasterPage() {
        if (event.key === 'F1') {
            window.location.href = '/measurement/';
            event.preventDefault();
        }
    }
    document.addEventListener('keydown', redirectToMasterPage);

function updateClock() {
    var now = new Date();
    var hours = now.getHours();
    var minutes = now.getMinutes();
    var seconds = now.getSeconds();
    var day = now.getDate();
    var month = now.getMonth() + 1; // January is 0, so we add 1 to get the actual month
    var year = now.getFullYear();

    // Format the time string
    var ampm = hours >= 12 ? 'PM' : 'AM'; // Determine if it's AM or PM
    hours = hours % 12; // Convert to 12-hour format
    hours = hours ? hours : 12; // Handle midnight (0 hours)
    var timeString = hours + ":" + minutes + ":" + seconds + " " + ampm;

    // Format the date string
    var dateString = day + "-" + month + "-" + year;

    var dateTimeString =  timeString  +  "/" +   dateString;

    // Update the clock display
    document.getElementById("clock-box").innerHTML = dateTimeString;

    // Call this function again after 1 second
    setTimeout(updateClock, 1000);
}

// Call the function to initially display the clock
updateClock();


function handleRadioClick(clickedRadio) {

    var selectedMastering = document.getElementById('mastering').value;

    var allParameterRadio = document.getElementById('all_parameter');
    var parameterwiseRadio = document.getElementById('parameterwise');
    var containerRadioButtons = document.querySelectorAll('[name="radio-container"]');
    var preTag = document.getElementById('pre');

    // Unselect the other radio button
    if (clickedRadio.id === 'all_parameter' && parameterwiseRadio.checked) {
            parameterwiseRadio.checked = false;
        } else if (clickedRadio.id === 'parameterwise' && allParameterRadio.checked) {
            allParameterRadio.checked = false;
        }


    else if (clickedRadio.id === 'all_parameter') {
        // Hide container radio buttons if 'All Parameter' radio button is clicked
        toggleContainerRadioButtons(false);
        preTag.innerText = 'All Parameters are selected for mastering: ' + selectedMastering;

    } else if (clickedRadio.id === 'parameterwise') {
        // Show container radio buttons if 'Parameterwise' radio button is clicked
        toggleContainerRadioButtons(true);
        preTag.innerText = 'Parameterwise is selected for mastering: ' + selectedMastering;

    }
}

// Function to toggle container radio buttons visibility
function toggleContainerRadioButtons(show) {
    const containerRadioButtons = document.querySelectorAll('[name="radio-container"]');
    containerRadioButtons.forEach(radioButton => {
        radioButton.style.display = show ? 'inline' : 'none';
    });
}
window.addEventListener('load',function(){
    toggleContainerRadioButtons(false);
});


// Event listeners for radio buttons
document.getElementById('all_parameter').addEventListener('change', function() {
    if (this.checked) {
        handleRadioClick(this);
    }
});

document.getElementById('parameterwise').addEventListener('change', function() {
    if (this.checked) {
        handleRadioClick(this);
    }
});
///////////////////////////////////////////


// Trigger click event on page load
window.addEventListener('load', function() {
    // Select the radio button
    setTimeout(function(){
        document.getElementById('all_parameter').click();
    },100);
    
    
});



// Event listener for the "All Parameter" radio button
document.getElementById('all_parameter').addEventListener('change', function() {
    if (this.checked) {
        displayAllContainerValues();
    }
    console.log("you are select the all parameter now");
});

// Function to display values for all containers
function displayAllContainerValues() {
    const containers = document.querySelectorAll('.input-box-container');
    containers.forEach(container => {
        displayContainerValues(container);
        displayValues(container);
    });
}


//////////////////////////////
    // Generate 50 input-box-container elements
    for (let i = 1; i <= 50; i++) {
        // Create a new container div
        const container = document.createElement('div');
        container.className = 'input-box-container';
        container.id = 'container-' + i;

        // Create radio button
        const radioButton = document.createElement('input');
        radioButton.type = 'radio';
        radioButton.name ='radio-container';
        radioButton.id = 'container-' + i + '_radioButton';
        radioButton.style.marginLeft = '70px';
        radioButton.style.marginTop = '0px';
        radioButton.addEventListener('change',function(){
            if (this.checked){
                console.log("selected radio button id:",this.id);
                displayContainerValues(container);
            }
        })
        container.appendChild(radioButton);
        container.appendChild(document.createElement('br'));
        toggleContainerRadioButtons(false);

         // Append container to the document body or any other container
    document.body.appendChild(container);


    


let probeNo;
const a1 ={}; // lowcount
const b1 ={}; // highcount
let callingFunction;
let a; // low master
let b; // high master
let e; // nominal
let d; // coefficient
let o1; // offset



////////////////////////////////////////////////////////////////

function displayValues(container) {

var selectedValue = document.getElementById('partModel').value;
    console.log('Selected Value: ' + selectedValue);

    var selectedMastering = document.getElementById('mastering').value;
    console.log('Selected MASTERING GROUP:', selectedMastering);

const inputs = container.querySelectorAll('.master_input');
const values = {};

inputs.forEach(input => {
    const inputName = mapInputIdToName(input.id);
    values[inputName] = input.value;
});

const preElement = container.querySelector('pre');
const preValue = preElement ? preElement.textContent.trim() : '';

values['preValue'] = preValue;

// Rename keys as needed
const lsl = parseFloat(values['lsl']);
const usl = parseFloat(values['usl']);
const e_values = parseFloat(values['e']);
const d_values = parseFloat(values['d']);
const o1_values = parseFloat(values['o1']);
const probe_values = parseFloat(values['probe_values']);
const digits = parseFloat(values['digits']);
const ltl = parseFloat(values['ltl']);
const utl = parseFloat(values['utl']);

console.log("Container values:", values);
console.log("e_values areeeeeee:",e_values);
console.log("d_values areeeeeeeee:",d_values);
console.log("o1_values areeeeeeee:",o1_values);
console.log("probe_values areeeeeeee:",probe_values);

// Map probe numbers to corresponding textarea IDs
const probeNo = values['probe_values'];

if (probeNo) {
    const probeTextareaId = mapProbeToTextareaId(probeNo);
    const probeTextarea = document.getElementById(probeTextareaId);

    if (probeTextarea) {
        const valueInTextarea = probeTextarea.value;
        console.log('Value in textarea:', probeTextareaId);



            // Function to handle serial data changes
            function handleSerialDataChange(newSerialData) {
                // Call calculateMastering with the appropriate values and newSerialData
                calculateDisplay(e_values, d_values, o1_values, newSerialData, container.id,lsl,usl,digits,ltl,utl)
                
            }

            // Get the initial serialData by calling displaySerialData
            const initialSerialData = displaySerialData(container, handleSerialDataChange);

            if (initialSerialData !== null) {
                // Call calculateMastering with the appropriate values and initialSerialData
                calculateDisplay(e_values, d_values, o1_values, initialSerialData, container.id)

            }
        }
    }
}


/////////////////////////////////////////////////////////////////



function displayContainerValues(container) {


    var now = new Date();
    var dateTimeString = now.toLocaleString(); // Format the date and time as per your requirement

    

    var selectedValue = document.getElementById('partModel').value;
        console.log('Selected Value: ' + selectedValue);

        var selectedMastering = document.getElementById('mastering').value;
        console.log('Selected MASTERING GROUP:', selectedMastering);

    const inputs = container.querySelectorAll('.master_input');
    const values = {};

    inputs.forEach(input => {
        const inputName = mapInputIdToName(input.id);
        values[inputName] = input.value;
    });

    const preElement = container.querySelector('pre');
    const preValue = preElement ? preElement.textContent.trim() : '';

    values['preValue'] = preValue;

    // Rename keys as needed
    const a = parseFloat(values['low_mv']);
    const b = parseFloat(values['high_mv']);
    const e = parseFloat(values['nominal']);
    const lsl = parseFloat(values['lsl']);
    const usl = parseFloat(values['usl']);
    const ltl = parseFloat(values['ltl']);
    const utl = parseFloat(values['utl']);
    const digits = parseFloat(values['digits']);

    console.log("Container values:", values);
    console.log("a:", a);
    console.log("b:", b);
    console.log("e:", e);
    console.log("lsl:",lsl);
    console.log("usl:",usl);
    console.log("ltl:",ltl);
    console.log("utl:",utl);
    console.log("digits:",digits);
    

    // Map probe numbers to corresponding textarea IDs
    const probeNo = values['probe_no'];

    if (probeNo) {
        const probeTextareaId = mapProbeToTextareaId(probeNo);
        const probeTextarea = document.getElementById(probeTextareaId);

        if (probeTextarea) {
            const valueInTextarea = probeTextarea.value;
            console.log('Value in textarea:', probeTextareaId);

            // Save the value based on the calling function
            if (callingFunction === 'lowMasteringClick') {
                // Store a1 value for the current container
                a1[container.id] = parseFloat(valueInTextarea);
                console.log("Saving value as 'a1':", a1[container.id]);
            } else if (callingFunction === 'highMasteringClick') {

                // Store b1 value for the current container
                b1[container.id] = parseFloat(valueInTextarea);
                console.log("Saving value as 'b1':", b1[container.id]);

                // Check the difference between a1 and b1 values
                const difference = Math.abs(b1[container.id] - a1[container.id]);
                if (difference < 5000) {
                    alert("Please do Proper Mastering");
                }

                // Perform calculations and display the output
                const c = b - a;
                const c1 = b1[container.id] - a1[container.id];
                const d = c / c1;
                const o = e + (a1[container.id] * d);
                const o1 = a - o;

                console.log("c:", c);
                console.log("c1:", c1);
                console.log("d:", d);
                console.log("o:", o);
                console.log("offset value:", o1);
                console.log("container value id:", container.id);
                // Prepare data to send
                

    const dataToSend = {
        
        probeNo: values['probe_no'],
        a: a,
        b: b,
        e:e,
        a1:a1,
        b1:b1,
        d:d,
        o1:o1,
        parameterName: preValue,
        containerId: container.id,
        selectedValue:selectedValue,
        selectedMastering:selectedMastering,
        dateTime: dateTimeString,


    };
    console.log('your value for this datatosend:',dataToSend);

    // Perform AJAX call to send data to the server

    $.ajax({
    url: '/master/',
    method: 'POST',
    headers:{
        'Content-Type':'application/json',
        'X-CSRFToken':getCookie('csrftoken'),
    },
    contentType: 'application/json',
    data: JSON.stringify(dataToSend),
    success: function(data) {
        console.log('Server response:', data);
    },
    error: function(xhr, status, error) {
        console.error('There was a problem with your AJAX request:', error);
    }
});


                // Function to handle serial data changes
                function handleSerialDataChange(newSerialData) {
                    // Call calculateMastering with the appropriate values and newSerialData
                    calculateMastering(e, d, o1, newSerialData, container.id,lsl,usl,ltl,utl,digits,preValue);
                    
                }

                // Get the initial serialData by calling displaySerialData
                const initialSerialData = displaySerialData(container, handleSerialDataChange);

                if (initialSerialData !== null) {
                    // Call calculateMastering with the appropriate values and initialSerialData
                    calculateMastering(e, d, o1, initialSerialData, container.id);

                }
            }
        }
    }
    return a;
}




function lowMasteringClick() {

    console.log("lowMasteringClick");
    document.getElementById("lowMasterBtn").disabled = true;
    document.getElementById("lowMasterBtn").style.opacity = '0.6';
    document.getElementById("highMasterBtn").disabled = false;
    document.getElementById("highMasterBtn").style.opacity = '1';

        const preTag = document.getElementById('pre');

        if (document.getElementById('all_parameter').checked) {
            const containers = document.querySelectorAll('.input-box-container');
            containers.forEach(container => {
                callingFunction = 'lowMasteringClick';

                // Capture the returned value of 'a' from displayContainerValues
                const a = displayContainerValues(container);

                // Assuming 'a' is the value you want to display
                console.log("Value of 'a':", a);

                const additionalInput = document.getElementById(container.id + '_additional_input');
                if (additionalInput) {
                    additionalInput.value = a;  // Set the value of the additional input field
                } else {
                    console.error('Additional input field not found for container:', container.id);
                }
            });

            // Display notification for low mastering in the pre tag
            preTag.innerText = 'All Parameter Low Mastering selected.';

        } else if (document.getElementById('parameterwise').checked) {
            const container = getSelectedContainer();
            callingFunction = 'lowMasteringClick';

            // Capture the returned value of 'a' from displayContainerValues
            const a = displayContainerValues(container);

            // Assuming 'a' is the value you want to display
            console.log("Value of 'a':", a);

            const additionalInput = document.getElementById(container.id + '_additional_input');
            if (additionalInput) {
                additionalInput.value = a;  // Set the value of the additional input field
            } else {
                console.error('Additional input field not found for container:', container.id);
            }

            // Display notification for low mastering in the pre tag
            preTag.innerText = 'Parameterwise Low Mastering selected.';
        }
        executeUpdateParameterValues = false; // Disable the updateParameterValues function
        executeupdateInputValue= false;
        executeUpdateAllParameterValues = false;
        executeupdateAdditionalInputValue = false;
    }

    function highMasteringClick() {
        console.clear();
    console.log("highMasteringClick");
    document.getElementById("lowMasterBtn").disabled = true;
    document.getElementById("lowMasterBtn").style.opacity = '0.6';
    document.getElementById("highMasterBtn").disabled = true;
    document.getElementById("highMasterBtn").style.opacity = '0.6';

    const preTag = document.getElementById('pre');

    if (document.getElementById('all_parameter').checked) {
        const containers = document.querySelectorAll('.input-box-container');
        containers.forEach(container => {
            callingFunction = 'highMasteringClick';
            displayContainerValues(container);
        });

        // Enable updateAllParameterValues function
        executeUpdateAllParameterValues = true;

        // Assuming you want to update additional input values after all containers are processed
        updateAllParameterValues();

        // Display notification for high mastering in the pre tag
        preTag.innerText = 'All Parameter High Mastering selected.';

    } else if (document.getElementById('parameterwise').checked) {
        const container = getSelectedContainer();
        callingFunction = 'highMasteringClick';
        displayContainerValues(container);

        // Enable updateAllParameterValues function
        executeUpdateAllParameterValues = true;

        updateAllParameterValues(container.id, container.lsl, container.usl);

        // Display notification for high mastering in the pre tag
        preTag.innerText = 'Parameterwise High Mastering selected.';
    }
}



// Function to get the selected container
function getSelectedContainer() {
    const selectedRadio = document.querySelector('input[name="radio-container"]:checked');
    if (selectedRadio) {
        const containerId = selectedRadio.id.replace('_radioButton', ''); // Extract container ID from radio button ID
        return document.getElementById(containerId);
    }
    return null;
}   



true




function mapInputIdToName(inputId) {
    const idParts = inputId.split('_');
    const inputType = idParts[idParts.length - 1];

    switch (inputType) {
        case 'input1':
            return 'low_mv';
        case 'input2':
            return 'high_mv';
        case 'input3':
            return 'probe_no';
        case 'input4':
            return 'nominal';
        case 'input5':
            return 'lsl';
        case 'input6':
            return 'usl';
        case 'input8':
            return 'd';
        case 'input9':
            return 'o1'; 
        case 'input10':
            return 'e';               
        case 'input11':
            return 'probe_values'; 
        case 'input12':
            return 'utl';
        case 'input13':
            return 'ltl';
        case 'input14':
            return 'digits';       
        default:
            return inputType;
    }
}

function mapProbeToTextareaId(probeNumber) {
    const probeMap = {
        '1': 'probe-A',
        '2': 'probe-B',
        '3': 'probe-C',
        '4': 'probe-D',
        '5': 'probe-E',
        '6': 'probe-F',
        '7': 'probe-G',
        '8': 'probe-H',
        '9': 'probe-I',
        '10': 'probe-J',
        '11': 'probe-K',

    };
   

    return probeMap[probeNumber];
}





let intervalIdRadio; // Separate variable for radio button interval
let intervalIdContainers; // Separate variable for container interval

// Add an event listener to each radio button inside the containers
document.querySelectorAll('input[name="radio-container"]').forEach(radioButton => {
    radioButton.addEventListener('change', function() {
        if (this.checked) {
            const container = this.closest('.input-box-container');
            displayContainerValues(container);
            
            // Clear the previous interval if exists
            clearInterval(intervalIdRadio);

            // Start a new interval to display serial data periodically
            intervalIdRadio = setInterval(() => {
                displaySerialData(container);
            }, 5000); // Adjust the interval time (in milliseconds) as needed
        }
    });
});

// Assume you want to display serial data for all containers
const containers = document.querySelectorAll('.input-box-container');


// Start a new interval to display serial data periodically for each container
containers.forEach(container => {
    displayContainerValues(container);
// Clear the previous interval if exists
clearInterval(intervalIdContainers);
    intervalIdContainers = setInterval(() => {
        displaySerialData(container);
    }, 5000); // Adjust the interval time (in milliseconds) as needed
});





// Function to display serial data
function displaySerialData(container, callback) {
    const inputElements = container.querySelectorAll('.master_input');
    const values = {};

    inputElements.forEach(input => {
        const inputName = mapInputIdToName(input.id);
        values[inputName] = input.value;
    });

    const probeInput = values['probe_no'];
    const textareaId = mapProbeToTextareaId(probeInput);
    const textarea = document.getElementById(textareaId);

    if (textarea) {
        // Function to check for changes in serial data
        function checkSerialData() {
            const newSerialData = textarea.value;

            // Call the callback function with the newSerialData
            callback(newSerialData);
        }

        // Attach an event listener to the textarea for changes
        textarea.addEventListener('input', checkSerialData);

        // Use setInterval to periodically check for changes
        const intervalId = setInterval(checkSerialData, 0.5); // Adjust the interval as needed

        // Return the initial value of serialData and intervalId
        return {
            initialValue: textarea.value,
            intervalId: intervalId,
        };
    } else {
        
        return null;
    }
}

///////////////////////////////////////

let k;


function calculateDisplay(e_values, d_values, o1_values, serialData, id, lsl, usl,digits,ltl,utl) {
    console.log('Entering calculateMastering');
    console.log('e values are akdfjcugabdkajdgaiu:', e_values);
    console.log('serialData:', serialData);
    console.log('d values are akduffgbaokeiuaodaiboasjdn:', d_values);
    console.log('o1 values areiiiiiiiiiiiiiiiiiiibbbbbbbbbbbbbikkkkkk:', o1_values);
    const rawMastering = parseFloat(e_values) + (serialData * d_values + o1_values);
    k = rawMastering.toFixed(digits);
    console.log('kkkkkkkkkkkkkkkkkkkkkkkkkkkkkkk valllllllllllluuuuuuuuuuuuueeeeee:',k);

    if (document.getElementById('parameterwise').checked) {
        console.log('Updating additional input value in calculateMastering:', k);
        updateInputValue(k,lsl,usl,ltl,utl);
    } else if (document.getElementById('all_parameter').checked) {
        console.log('Updating all parameter values in calculateMastering:', k);
        updateParameterValues(id,lsl,usl,ltl,utl);
    }
    return k;
}


let executeUpdateParameterValues = true;

function updateParameterValues(id, lsl, usl,ltl, utl) {
    if (!executeUpdateParameterValues) return;
    console.log("Updating all parameter values");

    const containers = document.querySelectorAll('.input-box-container');

    const additionalInput = document.getElementById(id + '_additional_input');
    
    if (additionalInput) {
        // Set the value of the additional input field with the global 'm' value
        additionalInput.value = k;

        if (k >= lsl && k <= usl) {
            additionalInput.style.backgroundColor = '#00ff00'; // Green
        } else if ((k > usl && k <= utl) || (k >= ltl && k < lsl)) {
            additionalInput.style.backgroundColor = 'yellow';
        } else if (k > utl || k < ltl) {
            additionalInput.style.backgroundColor = 'red';
        }
        console.log("additionalInput ID jjjjjjjjjjjjjjjjjjjjj:", additionalInput.id);

        
    } else {
        console.error('Additional input field not found for container:', id);
    }
}


let executeupdateInputValue= true;

function updateInputValue(value,lsl,usl,ltl,utl) {
    console.log("Updating additional input value:", value);
    if (!executeupdateInputValue) return;

    const container = getSelectedContainer();
    const additionalInput = document.getElementById(container.id + '_additional_input');
    

    if (additionalInput) {
        additionalInput.value = value;

        if (k >= lsl && k <= usl) {
            additionalInput.style.backgroundColor = '#00ff00'; // Green
        } else if ((k > usl && k <= utl) || (k >= ltl && k < lsl)) {
            additionalInput.style.backgroundColor = 'yellow';
        } else if (k > utl || k < ltl) {
            additionalInput.style.backgroundColor = 'red';
        }

        console.log("additionalInput ID jjjjjjjjjjjjjjjjjjjjj:", additionalInput.id);

        
    } else {
        console.error('Additional input field not found for container:', container.id);
    }
}


   
//////////////////////////////////////////

let m; // Declare m in the global scope

function calculateMastering(e, d, o1, serialData,id,lsl,usl,ltl,utl,digits,preValue) {
    console.log('Entering calculateMastering');
    console.log('e values are:', e);
    console.log('serialData:', serialData);
    console.log('d values are:', d);
    console.log('o1 values are:', o1);
    console.log('lsl vsluesssss areeeeeeee:',lsl);
    console.log('usl valuessss areeeeeeeee:',usl);
    console.log('jjjj container id:',id);
    console.log('ltl vsluesssss areeeeeeee:',ltl);
    console.log('utl valuessss areeeeeeeee:',utl);
    console.log('digits valuessss areeeeeeeee:',digits);

    const rawMastering = parseFloat(e) + (serialData * d + o1);

    // Format the mastering value to 4 decimal places
    m = rawMastering.toFixed(digits);

    console.log('Calculated Mastering:', m);

    if (document.getElementById('parameterwise').checked) {
        console.log('Updating additional input value in calculateMastering:', m);
        updateAdditionalInputValue(m,lsl,usl,ltl,utl,preValue);
    } else if (document.getElementById('all_parameter').checked) {
        console.log('Updating all parameter values in calculateMastering:', m);
        updateAllParameterValues(id,lsl,usl,ltl,utl,preValue);
    }

    // Return m if needed in other parts of your code
    return m;
}

let executeupdateAdditionalInputValue = true;

function updateAdditionalInputValue(value,lsl,usl,ltl,utl,preValue) {
    console.log("Updating additional input value:", value);

     if (!executeupdateAdditionalInputValue) return;

    const container = getSelectedContainer();
    const additionalInput = document.getElementById(container.id + '_additional_input');

    if (additionalInput) {
        additionalInput.value = value;

        if (m >= lsl && m <= usl) {
            additionalInput.style.backgroundColor = '#00ff00'; // Green
        } else if ((m > usl && m <= utl) || (m >= ltl && m < lsl)) {
            additionalInput.style.backgroundColor = 'yellow';
        } else if (m > utl || m < ltl) {
            additionalInput.style.backgroundColor = 'red';
        }


        
    } else {
        console.error('Additional input field not found for container:', container.id);
    }
}


let executeUpdateAllParameterValues = true;


function updateAllParameterValues(id, lsl, usl,ltl,utl,preValue) {
    if (!executeUpdateAllParameterValues) return;
    console.log("Updating all parameter values");
    console.log("prevalues:",preValue);

    const containers = document.querySelectorAll('.input-box-container');

    const additionalInput = document.getElementById(id + '_additional_input');

    if (additionalInput) {
        // Set the value of the additional input field with the global 'm' value
        additionalInput.value = m;

        if (m >= lsl && m <= usl) {
            additionalInput.style.backgroundColor = '#00ff00'; // Green
        } else if ((m > usl && m <= utl) || (m >= ltl && m < lsl)) {
            additionalInput.style.backgroundColor = 'yellow';
        } else if (m > utl || m < ltl) {
            additionalInput.style.backgroundColor = 'red';
        }

        
    } else {
        console.error('Additional input field not found for container:', id);
    }
}




////////////////////////////////////

        // Create L: input fields
        container.appendChild(document.createTextNode('L:'));
        for (let j = 1; j <= 1; j++) {
            const inputL = document.createElement('input');
            inputL.className = 'master_input';
            inputL.type = 'text';
            inputL.id = 'container-' + i + '_input' + j;
            container.appendChild(inputL);

            // Add a small space after each inputL
            container.appendChild(document.createTextNode(' '));
        }
        container.appendChild(document.createElement('br'));

        // Create H: input fields
        container.appendChild(document.createTextNode('H:'));
        for (let k = 2; k <= 2; k++) {
            const inputH = document.createElement('input');
            inputH.className = 'master_input';
            inputH.type = 'text';
            inputH.id = 'container-' + i + '_input' + k;
            container.appendChild(inputH);

            // Add a small space after each inputL
            container.appendChild(document.createTextNode(' '));
        }

        // Create additional input field
        const additionalInput = document.createElement('input');
        additionalInput.className = 'master_input';
        additionalInput.type = 'text';
        additionalInput.id = 'container-' + i + '_additional_input'; // Adjust ID as needed

        // Append the additional input inside the container
        container.appendChild(additionalInput);
        container.appendChild(document.createTextNode(' ')); // Add a space after the additional input

        // Append a line break to ensure proper layout
        container.appendChild(document.createElement('br'));



        // Create additional PN: input field

        for (let p = 3; p <= 4; p++) {  // Update the loop condition for additional input box
            const inputPN = document.createElement('input');
            inputPN.className = 'master_input';
            inputPN.type = 'text';
            inputPN.id = 'container-' + i + '_input' + p;
            container.appendChild(inputPN);

            inputPN.style.display ='none';

            

            // Add a small space after each inputPN
            container.appendChild(document.createTextNode(' '));
        }

       
        for (let p = 5; p <= 6; p++) {  // Update the loop condition for additional input box
            const inputPN = document.createElement('input');
            inputPN.className = 'master_input';
            inputPN.type = 'text';
            inputPN.id = 'container-' + i + '_input' + p;
            container.appendChild(inputPN);

            inputPN.style.display ='none';
            

            // Add a small space after each inputPN
            container.appendChild(document.createTextNode(' '));
        }

        for (let p = 7; p <= 7; p++) {  // Update the loop condition for additional input box
            const inputPN = document.createElement('input');
            inputPN.className = 'master_input';
            inputPN.type = 'text';
            inputPN.id = 'container-' + i + '_input' + p;
            container.appendChild(inputPN);
            inputPN.style.display ='none';
            
        }

        for (let p = 8; p <= 8; p++) {  // Update the d_values
            const inputPN = document.createElement('input');
            inputPN.className = 'master_input';
            inputPN.type = 'text';
            inputPN.id = 'container-' + i + '_input' + p;
            container.appendChild(inputPN);
            inputPN.style.display ='none';
            
        }

        for (let p = 9; p <= 9; p++) {  // Update the loop condition for additional input box
            const inputPN = document.createElement('input');
            inputPN.className = 'master_input';
            inputPN.type = 'text';
            inputPN.id = 'container-' + i + '_input' + p;
            container.appendChild(inputPN);
            inputPN.style.display ='none';
            
        }

        for (let p = 10; p <= 10; p++) {  // Update the loop condition for additional input box
            const inputPN = document.createElement('input');
            inputPN.className = 'master_input';
            inputPN.type = 'text';
            inputPN.id = 'container-' + i + '_input' + p;
            container.appendChild(inputPN);
            inputPN.style.display ='none';
            
        }

        for (let p = 11; p <= 11; p++) {  // Update the loop condition for additional input box
            const inputPN = document.createElement('input');
            inputPN.className = 'master_input';
            inputPN.type = 'text';
            inputPN.id = 'container-' + i + '_input' + p;
            container.appendChild(inputPN);
            inputPN.style.display ='none';
            
        }

        for (let p = 12; p <= 14; p++) {  // Update the loop condition for additional input box
            const inputPN = document.createElement('input');
            inputPN.className = 'master_input';
            inputPN.type = 'text';
            inputPN.id = 'container-' + i + '_input' + p;
            container.appendChild(inputPN);
            inputPN.style.display ='none';
            
            
        }

        


        // Style the additional input box using CSS
        additionalInput.style.position = 'absolute';
        additionalInput.style.top = '50%';
        additionalInput.style.transform = 'translateY(-50%)';
        additionalInput.style.height = '70px'; // Adjust height as needed
        additionalInput.style.marginLeft = '5px'; // Adjust height as needed

        // Style the container to position it relatively
        container.style.position = 'relative';



        // Create pre element
        const preElement = document.createElement('pre');
        preElement.id = 'pre_' + i;
        preElement.style.marginTop = '0px';
        preElement.style.marginLeft = '50px';
        preElement.appendChild(document.createTextNode(''));
        container.appendChild(preElement);

        // Append the container to the container-wrapper
        document.getElementById('container-wrapper').appendChild(container);
    
    }







 // Function to fetch and update values based on selected options
 function updateValues() {
        var selectedValue = document.getElementById('partModel').value;
        console.log('Selected Value: ' + selectedValue);

        var selectedMastering = document.getElementById('mastering').value;
        console.log('Selected MASTERING GROUP:', selectedMastering);

        // Make an AJAX request to the backend
        fetch('/master/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'), // Include CSRF token for Django
            },
            body: JSON.stringify({
                selectedValue: selectedValue,
                selectedMastering: selectedMastering,
            }),
        })
        .then(response => response.json())
        .then(data => {
            // Extract parameter names from the response data
            const parameter_names = data.parameter_names;

            // Check if no values from selected mastering, then show alert message and remove parameter names from pre tags
            if (!parameter_names || parameter_names.length === 0) {
                alert('No parameter names available for selected mastering.');

                // Clear all pre tags
                for (let i = 1; i <= 50; i++) {
                    const preElement = document.getElementById('pre_' + i);
                    preElement.innerHTML = '';
                }
            } else {
                // Iterate over the parameter names and update the corresponding pre tags
                for (let i = 1; i <= parameter_names.length; i++) {
                    const preElement = document.getElementById('pre_' + i);
                    preElement.innerHTML = '<b style="color: red;">' + parameter_names[i - 1] + '</b>';
                }
                // Clear the remaining pre tags if there are fewer parameter names than the total number of pre tags
                for (let i = parameter_names.length + 1; i <= 50; i++) {
                    const preElement = document.getElementById('pre_' + i);
                    preElement.innerHTML = '';
                }
            }

            for (let i = parameter_names.length + 1; i <= 50; i++) {
    const inputProbeNo = document.getElementById('container-' + i + '_input3'); 
    const inputNominal = document.getElementById('container-' + i + '_input4'); 
    const inputusl = document.getElementById('container-' + i + '_input6'); 
    const inputlsl = document.getElementById('container-' + i + '_input5'); 
    const inputMastering = document.getElementById('container-' + i + '_input7'); 
    const inputd = document.getElementById('container-' + i + '_input8');
    const inputo1 = document.getElementById('container-' + i + '_input9');
    const inpute = document.getElementById('container-' + i + '_input10');
    const inputprobe = document.getElementById('container-' + i + '_input11');
    const inpututl = document.getElementById('container-' + i + '_input12');
    const inputltl = document.getElementById('container-' + i + '_input13');
    const inputdigits = document.getElementById('container-' + i + '_input14'); 

    inputProbeNo.value = '';
    inputNominal.value = '';
    inputusl.value = '';
    inputlsl.value = '';
    inputMastering.value = '';
    inputd.value = '';
    inputo1.value = '';
    inpute.value = '';
    inputprobe.value = '';
    inpututl.value ='';
    inputltl.value ='';
    inputdigits.value ='';
    
            }


////////////////////////////////////////////////////////////




// Extract probeNo values from the response data
const probeNo_values = data.probe_no;
console.log('probeNo_values:', probeNo_values);

// Extract nominal values from the response data
const nominal_values = data.nominal;
console.log('nominal_values:', nominal_values);


const usl = data.usl;
console.log('usl value is :',usl);

const lsl = data.lsl;
console.log('lsl value is:',lsl);

const mastering = data.mastering;
console.log('mastering value is:',mastering);



const o1_values = data.o1_values;
console.log('o1 value is:',o1_values);

const d_values = data.d_values;
console.log('d value is:',d_values);


const e_values = data.e_values;
console.log('e value is:',e_values);


const probe_values = data.probe_values;
console.log('probe value is:',probe_values);

const utl = data.utl;
console.log('utl value is :',utl);

const ltl = data.ltl;
console.log('ltl value is:',ltl);

const digits = data.digits;
console.log('digits value is:',digits);




// Iterate over the probeNo values and update the corresponding input fields
for (let i = 1; i <= Math.min(probeNo_values.length, 50); i++) {
    const inputProbeNo = document.getElementById('container-' + i + '_input3'); // Assuming 'input2' is for probeNo
    inputProbeNo.value = probeNo_values[i - 1];
}

// Iterate over the nominal values and update the corresponding input fields
for (let i = 1; i <= Math.min(nominal_values.length, 50); i++) {
    const inputNominal = document.getElementById('container-' + i + '_input4'); // Assuming 'input3' is for nominal
    inputNominal.value = nominal_values[i - 1];
}

for (let i = 1; i <= Math.min(usl.length, 50); i++) {
    const inputusl = document.getElementById('container-' + i + '_input6'); // Assuming 'input3' is for nominal
    inputusl.value = usl[i - 1];
}


for (let i = 1; i <= Math.min(lsl.length, 50); i++) {
    const inputlsl = document.getElementById('container-' + i + '_input5'); // Assuming 'input3' is for nominal
    inputlsl.value = lsl[i - 1];
}


// Iterate over the probeNo values and update the corresponding input fields
for (let i = 1; i <= Math.min(d_values.length, 50); i++) {
    const inputd_values = document.getElementById('container-' + i + '_input8'); // Assuming 'input2' is for probeNo
    inputd_values.value = d_values[i - 1];
}

for (let i = 1; i <= Math.min(o1_values.length, 50); i++) {
    const inputo1_values = document.getElementById('container-' + i + '_input9'); // Assuming 'input2' is for probeNo
    inputo1_values.value = o1_values[i - 1];
}

for (let i = 1; i <= Math.min(e_values.length, 50); i++) {
    const inpute_values = document.getElementById('container-' + i + '_input10'); // Assuming 'input2' is for probeNo
    inpute_values.value = e_values[i - 1];
}

for (let i = 1; i <= Math.min(probe_values.length, 50); i++) {
    const inputprobe_values = document.getElementById('container-' + i + '_input11'); // Assuming 'input2' is for probeNo
    inputprobe_values.value = probe_values[i - 1];
}

for (let i = 1; i <= Math.min(utl.length, 50); i++) {
    const inpututl = document.getElementById('container-' + i + '_input12'); // Assuming 'input2' is for probeNo
    inpututl.value = utl[i - 1];
}

for (let i = 1; i <= Math.min(ltl.length, 50); i++) {
    const inputltl = document.getElementById('container-' + i + '_input13'); // Assuming 'input2' is for probeNo
    inputltl.value = ltl[i - 1];
}

for (let i = 1; i <= Math.min(digits.length, 50); i++) {
    const inputdigits = document.getElementById('container-' + i + '_input14'); // Assuming 'input2' is for probeNo
    inputdigits.value = digits[i - 1];
}

for (let i = 1; i <= Math.min(mastering.length, 50); i++) {
    const inputmastering = document.getElementById('container-' + i + '_input7'); 
    inputmastering.value = mastering[i - 1];
    const container = document.getElementById('container-' + i);
        // Disable inputL
    const inputL = document.getElementById('container-' + i + '_input1');
    
    // Disable inputH
    const inputH = document.getElementById('container-' + i + '_input2');
    

    // Disable additional input
    const additionalInput = document.getElementById('container-' + i + '_additional_input');

    const radioButton = document.getElementById('container-' + i + '_radioButton');
    


    if (inputmastering.value === '') {
        container.style.backgroundColor = ''; // Clear the background color
        inputmastering.disabled = true; // Disable the input box
        inputL.disabled = true;
        inputH.disabled = true;
        additionalInput.disabled = true;
        radioButton.disabled = true;

    } else if (inputmastering.value === selectedMastering) {
        container.style.backgroundColor = 'pink';
        inputmastering.disabled = false; // Enable the input box
        inputL.disabled = false;
        inputH.disabled = false;
        additionalInput.disabled = false;
        radioButton.disabled = false;
    } else {
        container.style.backgroundColor = '';
        inputmastering.disabled = true; // Disable the input box
        inputL.disabled = true;
        inputH.disabled = true;
        additionalInput.disabled = true;
        radioButton.disabled = true;

    }


}










/////////////////////////////////////////

            // Reset previous low_mv values
            for (let i = 1; i <= 50; i++) {
                const inputLowMV = document.getElementById('container-' + i + '_input1');
                inputLowMV.value = '';
            }

            // Reset previous high_mv values
            for (let i = 1; i <= 50; i++) {
                const inputHighMV = document.getElementById('container-' + i + '_input2');
                inputHighMV.value = '';
            }

            // Extract low_mv values from the response data
            const low_mv_values = data.low_mv;
            console.log('low_mv_values no:',low_mv_values)
            // Extract high_mv values from the response data
            const high_mv_values = data.high_mv;
            console.log('high_mv_values no:',high_mv_values)

            // Check if low_mv values are available and update input fields
            if (low_mv_values && low_mv_values.length > 0) {
                for (let i = 1; i <= low_mv_values.length; i++) {
                    const inputLowMV = document.getElementById('container-' + i + '_input1');
                    inputLowMV.value = low_mv_values[i - 1];
                }
            } else {
                console.error('No or empty low_mv values received from the backend.');
            }

            // Check if high_mv values are available and update input fields
            if (high_mv_values && high_mv_values.length > 0) {
                for (let i = 1; i <= high_mv_values.length; i++) {
                    const inputHighMV = document.getElementById('container-' + i + '_input2');
                    inputHighMV.value = high_mv_values[i - 1];
                }
            } else {
                console.error('No or empty high_mv values received from the backend.');
            }

        })
        .catch(error => {
            console.error('Error:', error);
        });
        resetRadioButtons();
    }



    // Attach event listener to the partModel select element
    document.getElementById('partModel').addEventListener('change', updateValues);

    // Attach event listener to the mastering select element
    document.getElementById('mastering').addEventListener('change', updateValues);

    // Function to get CSRF token from cookies
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                // Check if the cookie name matches the desired name
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Initial update when the page loads
    updateValues();


function resetRadioButtons() {
    const radioButtons = document.querySelectorAll('input[name="radio-container"]');
    radioButtons.forEach(radioButton => {
        radioButton.checked = false;
    });
}

//////////////////////////////////////////////

 
///////////////////////////////////


// Clear input fields if data is not fetched from the backend
if (o1_values.length === 0 || d_values.length === 0 || e_values.length === 0 || probe_values.length === 0) {
    for (let i = 1; i <= 50; i++) {
        const inputd = document.getElementById('container-' + i + '_input8');
        const inputo1 = document.getElementById('container-' + i + '_input9');
        const inpute = document.getElementById('container-' + i + '_input10');
        const inputprobe = document.getElementById('container-' + i + '_input11');

        // Clear input values
        if (inputd) inputd.value = '';
        if (inputo1) inputo1.value = '';
        if (inpute) inpute.value = '';
        if (inputprobe) inputprobe.value = '';
    }
} 

</script>

{% endblock content %}